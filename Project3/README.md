# SM3 哈希函数 - 实现与优化说明文档

作者：李云昊  
邮箱：1779551322@qq.com  
许可证：MIT  

---

## 🧠 项目背景

SM3 是中国国家密码管理局发布的哈希函数标准（GM/T 0004-2012），广泛应用于电子政务、数字签名、身份认证等领域。

本项目围绕 SM3 哈希算法展开，目标是：
- 编写基础版本 SM3 实现
- 利用多种软件工程技巧对其进行优化
- 通过性能基准测试评估优化效果
- 实现代码的可读性与可维护性

---

## 📐 SM3 算法推导过程

SM3 采用 **Merkle-Damgård** 构造，结构与 SHA-256 相似，具有如下特点：

### 1. 输入预处理
- 原始消息经过 padding，填充到长度为 512 位的倍数
- 填充格式为：`消息 || 1 || 0...0 || 消息长度（64 位）`

### 2. 消息分块
- 将填充后的消息分为 N 个 512 位的消息块 `B[0], B[1], ..., B[N-1]`

### 3. 消息扩展（消息调度）
每个块经过如下扩展生成 W 和 W′：
```c
// W[0..15] 直接取原始块内容
for (j = 16; j < 68; j++) {
    W[j] = P1(W[j-16] ^ W[j-9] ^ ROTL(W[j-3], 15)) ^ ROTL(W[j-13], 7) ^ W[j-6];
}
for (j = 0; j < 64; j++) {
    W1[j] = W[j] ^ W[j+4];
}
```

### 4. 迭代压缩函数 CF
- 初始化向量 IV 为 8 个 32 位常量
- 每一轮对状态变量 A–H 进行 64 次更新：

```c
SS1 = ROTL((ROTL(A, 12) + E + ROTL(T[j], j)), 7);
SS2 = SS1 ^ ROTL(A, 12);
TT1 = FF(A, B, C, j) + D + SS2 + W1[j];
TT2 = GG(E, F, G, j) + H + SS1 + W[j];
```

压缩轮函数使用 2 个不同的非线性函数 `FF` 和 `GG`：

- 当 j ∈ [0,15]：  
  `FF = A ⊕ B ⊕ C`, `GG = E ⊕ F ⊕ G`
- 当 j ∈ [16,63]：  
  `FF = (A & B) | (A & C) | (B & C)`, `GG = (E & F) | (~E & G)`

最后，将本轮输出与上一轮结果做异或，形成新的链值。

---

## 🧪 优化实现说明

### 🧩 宏定义优化
将常用函数抽象为宏，避免函数调用开销：
```c
#define ROTL(x,n) (((x) << (n)) | ((x) >> (32 - (n))))
#define FF0(x,y,z) ((x) ^ (y) ^ (z)) // j ∈ [0,15]
#define FF1(x,y,z) ((x & y) | (x & z) | (y & z)) // j ∈ [16,63]
```

### 🔁 循环展开
例如消息扩展部分的 `for` 循环可以展开为块处理，以减少跳转开销并利于指令并行。

### 🧮 SIMD 优化（使用 SSE 指令）
针对 P1 运算进行并行处理：
```c
// P1(x) = x ^ (x <<< 15) ^ (x <<< 23)
__m128i X = _mm_set1_epi32(...);
__m128i rol15 = _mm_xor_si128(X, _mm_or_si128(_mm_slli_epi32(X,15), _mm_srli_epi32(X,17)));
__m128i rol23 = _mm_or_si128(_mm_slli_epi32(X,23), _mm_srli_epi32(X,9));
__m128i P1_result = _mm_xor_si128(X, _mm_xor_si128(rol15, rol23));
```

---

## 📂 文件结构说明

```text
.
├── sm3_basic.c / sm3_basic.h          # 基础 SM3 实现
├── sm3_optimized.c / sm3_optimized.h  # 三种优化方式实现（宏、展开、SIMD）
├── benchmark.c                        # 性能测试主程序
├── README.md                          # 英文说明文档
└── README_zh.md                       # 中文说明文档（本文件）
```

---

## 📊 性能实验结果（运行后填写）

| 实现版本     | 平均耗时 (ms) | 相对加速比 |
|--------------|----------------|-------------|
| 基础版本     |                | 1.00×       |
| 宏定义优化   |                |             |
| 循环展开优化 |                |             |
| SIMD优化     |                |             |

> 运行 `./benchmark` 可自动输出该表格所需数据。

---

## 📜 开源许可证

本项目遵循 [MIT 协议](https://opensource.org/licenses/MIT)：
- 可自由使用、修改、发布、商用
- 请保留作者信息及本协议内容

---

## 📬 联系方式

如需合作、建议或讨论算法实现，欢迎联系：

📧 **邮箱：** 1779551322@qq.com  
✍️ 期待你的反馈与建议！
